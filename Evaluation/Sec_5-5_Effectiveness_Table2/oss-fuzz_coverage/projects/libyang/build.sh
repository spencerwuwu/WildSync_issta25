#!/bin/bash -eu
# Copyright 2021 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
################################################################################

cd libyang
#git checkout devel

mkdir build && cd build
cmake -DBUILD_SHARED_LIBS=OFF -DENABLE_TOOLS=OFF ..
make

static_pcre=($(find /src/pcre2 -name "libpcre2-8.a"))

for fuzzer in lyd_parse_mem_json lyd_parse_mem_xml lys_parse_mem; do
  $CC $CFLAGS -c ../tests/fuzz/${fuzzer}.c -I./libyang -I./compat
  $CXX $CXXFLAGS $LIB_FUZZING_ENGINE ${fuzzer}.o -o $OUT/${fuzzer} \
    ./libyang.a ${static_pcre}
done

new_fuzzers="libyang__ly_ctx_compile__0 libyang__ly_ctx_compile__1 libyang__ly_ctx_compile__2 libyang__ly_ctx_compile__3 libyang__ly_ctx_get_change_count__0 libyang__ly_ctx_get_change_count__1 libyang__ly_ctx_get_module__1 libyang__ly_ctx_get_module__3 libyang__ly_ctx_get_module_imp_clb__0 libyang__ly_ctx_get_module_imp_clb__1 libyang__ly_ctx_get_module_implemented__0 libyang__ly_ctx_get_module_implemented__1 libyang__ly_ctx_get_module_implemented__10 libyang__ly_ctx_get_module_implemented__2 libyang__ly_ctx_get_module_implemented__3 libyang__ly_ctx_get_module_implemented__5 libyang__ly_ctx_get_module_implemented__6 libyang__ly_ctx_get_module_implemented__7 libyang__ly_ctx_get_module_implemented__8 libyang__ly_ctx_get_module_implemented__9 libyang__ly_ctx_get_module_iter__0 libyang__ly_ctx_get_module_iter__2 libyang__ly_ctx_get_module_iter__3 libyang__ly_ctx_get_module_iter__4 libyang__ly_ctx_get_module_iter__5 libyang__ly_ctx_get_module_iter__7 libyang__ly_ctx_get_module_latest__1 libyang__ly_ctx_get_modules_hash__4 libyang__ly_ctx_get_searchdirs__1 libyang__ly_ctx_internal_modules_count__0 libyang__ly_ctx_internal_modules_count__1 libyang__ly_ctx_load_module__0 libyang__ly_ctx_load_module__3 libyang__ly_ctx_load_module__7 libyang__ly_err_clean__0 libyang__ly_err_clean__1 libyang__ly_err_clean__2 libyang__ly_err_clean__3 libyang__ly_err_clean__4 libyang__ly_err_clean__5 libyang__ly_err_first__0 libyang__ly_err_first__1 libyang__ly_err_first__5 libyang__lyd_any_copy_value__0 libyang__lyd_any_value_str__4 libyang__lyd_change_term__0 libyang__lyd_change_term__1 libyang__lyd_change_term__2 libyang__lyd_change_term_bin__0 libyang__lyd_child__0 libyang__lyd_child__1 libyang__lyd_child__10 libyang__lyd_child__3 libyang__lyd_child__4 libyang__lyd_child__5 libyang__lyd_child__6 libyang__lyd_child__7 libyang__lyd_child__8 libyang__lyd_child__9 libyang__lyd_child_no_keys__0 libyang__lyd_child_no_keys__1 libyang__lyd_child_no_keys__2 libyang__lyd_child_no_keys__4 libyang__lyd_child_no_keys__5 libyang__lyd_child_no_keys__6 libyang__lyd_compare_single__0 libyang__lyd_compare_single__1 libyang__lyd_compare_single__2 libyang__lyd_diff_apply_module__0 libyang__lyd_diff_merge_all__0 libyang__lyd_diff_merge_module__0 libyang__lyd_diff_merge_tree__0 libyang__lyd_diff_reverse_all__0 libyang__lyd_diff_siblings__0 libyang__lyd_diff_siblings__1 libyang__lyd_dup_siblings__0 libyang__lyd_dup_siblings__1 libyang__lyd_dup_siblings_to_ctx__0 libyang__lyd_dup_single__2 libyang__lyd_dup_single__3 libyang__lyd_eval_xpath__0 libyang__lyd_find_path__0 libyang__lyd_find_path__1 libyang__lyd_find_path__2 libyang__lyd_find_path__3 libyang__lyd_find_path__4 libyang__lyd_find_path__5 libyang__lyd_find_path__6 libyang__lyd_find_path__7 libyang__lyd_find_path__8 libyang__lyd_find_path__9 libyang__lyd_find_sibling_first__0 libyang__lyd_find_sibling_opaq_next__0 libyang__lyd_find_sibling_opaq_next__1 libyang__lyd_find_sibling_opaq_next__10 libyang__lyd_find_sibling_opaq_next__2 libyang__lyd_find_sibling_opaq_next__3 libyang__lyd_find_sibling_opaq_next__4 libyang__lyd_find_sibling_opaq_next__5 libyang__lyd_find_sibling_opaq_next__6 libyang__lyd_find_sibling_opaq_next__7 libyang__lyd_find_sibling_opaq_next__8 libyang__lyd_find_sibling_opaq_next__9 libyang__lyd_find_sibling_val__1 libyang__lyd_find_xpath__0 libyang__lyd_find_xpath__1 libyang__lyd_find_xpath__2 libyang__lyd_first_sibling__0 libyang__lyd_first_sibling__1 libyang__lyd_first_sibling__2 libyang__lyd_first_sibling__3 libyang__lyd_first_sibling__4 libyang__lyd_first_sibling__5 libyang__lyd_first_sibling__6 libyang__lyd_get_value__0 libyang__lyd_get_value__1 libyang__lyd_get_value__2 libyang__lyd_get_value__4 libyang__lyd_get_value__5 libyang__lyd_insert_after__0 libyang__lyd_insert_before__0 libyang__lyd_insert_before__1 libyang__lyd_insert_child__0 libyang__lyd_insert_child__1 libyang__lyd_insert_child__2 libyang__lyd_insert_child__3 libyang__lyd_insert_child__4 libyang__lyd_insert_child__5 libyang__lyd_insert_child__6 libyang__lyd_insert_sibling__0 libyang__lyd_insert_sibling__1 libyang__lyd_insert_sibling__10 libyang__lyd_insert_sibling__2 libyang__lyd_insert_sibling__3 libyang__lyd_insert_sibling__4 libyang__lyd_insert_sibling__5 libyang__lyd_insert_sibling__6 libyang__lyd_insert_sibling__7 libyang__lyd_insert_sibling__8 libyang__lyd_insert_sibling__9 libyang__lyd_list_pos__0 libyang__lyd_merge_siblings__0 libyang__lyd_merge_siblings__2 libyang__lyd_merge_siblings__3 libyang__lyd_new_any__0 libyang__lyd_new_attr2__0 libyang__lyd_new_attr__0 libyang__lyd_new_attr__1 libyang__lyd_new_implicit_all__0 libyang__lyd_new_implicit_all__1 libyang__lyd_new_implicit_module__0 libyang__lyd_new_implicit_tree__2 libyang__lyd_new_implicit_tree__3 libyang__lyd_new_inner__0 libyang__lyd_new_inner__1 libyang__lyd_new_inner__2 libyang__lyd_new_inner__3 libyang__lyd_new_list3__0 libyang__lyd_new_meta2__0 libyang__lyd_new_opaq__0 libyang__lyd_new_path2__0 libyang__lyd_new_path2__1 libyang__lyd_new_path2__2 libyang__lyd_new_path2__4 libyang__lyd_new_path2__6 libyang__lyd_new_path__0 libyang__lyd_new_path__4 libyang__lyd_new_path__5 libyang__lyd_new_path__6 libyang__lyd_new_term__2 libyang__lyd_new_term__3 libyang__lyd_node_schema__0 libyang__lyd_owner_module__5 libyang__lyd_owner_module__6 libyang__lyd_owner_module__7 libyang__lyd_owner_module__8 libyang__lyd_owner_module__9 libyang__lyd_parent__10 libyang__lyd_parent__5 libyang__lyd_parent__6 libyang__lyd_parent__7 libyang__lyd_parent__8 libyang__lyd_parent__9 libyang__lyd_parse_data_path__0 libyang__lyd_parse_data_path__2 libyang__lyd_parse_data_path__3 libyang__lyd_parse_data_path__4 libyang__lyd_parse_op__0 libyang__lyd_parse_op__6 libyang__lyd_path__0 libyang__lyd_path__2 libyang__lyd_path__3 libyang__lyd_path__4 libyang__lyd_trim_xpath__0 libyang__lyd_unlink_siblings__0 libyang__lyd_unlink_tree__0 libyang__lyd_unlink_tree__1 libyang__lyd_unlink_tree__2 libyang__lyd_unlink_tree__3 libyang__lyd_unlink_tree__4 libyang__lyd_unlink_tree__5 libyang__lyd_unlink_tree__6 libyang__lyd_unlink_tree__7 libyang__lyd_validate_all__4 libyang__lyd_validate_all__5 libyang__lyd_validate_module__0 libyang__lyd_validate_op__0 libyang__lyd_validate_op__1 libyang__lyd_validate_op__2 libyang__lyd_validate_op__3 libyang__lydict_remove__0 libyang__lydict_remove__1 libyang__lydict_remove__10 libyang__lydict_remove__2 libyang__lydict_remove__3 libyang__lydict_remove__4 libyang__lydict_remove__5 libyang__lydict_remove__6 libyang__lydict_remove__7 libyang__lydict_remove__8 libyang__lydict_remove__9 libyang__lyplg_ext_insert__0 libyang__lyplg_ext_insert__1 libyang__lyplg_ext_insert__2 libyang__lyplg_ext_insert__3 libyang__lys_find_path__1 libyang__lys_find_path__10 libyang__lys_find_path__2 libyang__lys_find_path__3 libyang__lys_find_path__4 libyang__lys_find_path__5 libyang__lys_find_path__6 libyang__lys_find_path__7 libyang__lys_find_path__8 libyang__lys_find_path__9 libyang__lys_find_xpath__0 libyang__lys_find_xpath__1 libyang__lys_find_xpath_atoms__0"

for new_f in $new_fuzzers; do
  cp $SRC/new_fuzzers/${new_f}.cpp ../tests/fuzz/${new_f}.c
  $CC $CFLAGS -c ../tests/fuzz/${new_f}.c -I./libyang -I./compat
  $CXX $CXXFLAGS $LIB_FUZZING_ENGINE ${new_f}.o -o $OUT/${new_f} \
    ./libyang.a ${static_pcre}
done

